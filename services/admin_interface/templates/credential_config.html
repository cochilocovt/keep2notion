{% extends "base.html" %}

{% block title %}Credential Configuration - Google Keep to Notion Sync{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">Credential Configuration</h1>
        <p class="text-muted">Manage Google Keep OAuth credentials and Notion API tokens. All credentials are encrypted before storage.</p>
    </div>
</div>

<div class="row">
    <!-- Credential Form -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    {% if selected_credential %}
                        Edit Credentials for {{ selected_user_id }}
                    {% else %}
                        Add New Credentials
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <form method="post" id="credentialForm">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="save">
                    
                    <div class="mb-3">
                        <label for="user_id" class="form-label">User ID / Gmail Address <span class="text-danger">*</span></label>
                        <input 
                            type="text" 
                            class="form-control" 
                            id="user_id" 
                            name="user_id" 
                            value="{{ selected_user_id }}"
                            {% if selected_credential %}readonly{% endif %}
                            required
                            placeholder="e.g., yourname@gmail.com"
                        >
                        <small class="form-text text-muted">Your Gmail address (used for Google Keep authentication)</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="google_oauth_token" class="form-label">Google Keep Master Token <span class="text-danger">*</span></label>
                        <input 
                            type="text" 
                            class="form-control" 
                            id="google_oauth_token" 
                            name="google_oauth_token" 
                            value="{% if selected_credential %}********{% endif %}"
                            required
                            placeholder="Enter master token (e.g., aas_et/AKqwertyuiop...)"
                        >
                        <small class="form-text text-muted">Master token from OAuth conversion (will be encrypted). See documentation for how to obtain.</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="notion_api_token" class="form-label">Notion API Token <span class="text-danger">*</span></label>
                        <textarea 
                            class="form-control" 
                            id="notion_api_token" 
                            name="notion_api_token" 
                            rows="3"
                            required
                            placeholder="Enter Notion API token (starts with secret_)"
                        >{% if selected_credential %}********{% endif %}</textarea>
                        <small class="form-text text-muted">Notion integration token (will be encrypted)</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="notion_database_id" class="form-label">Notion Database ID <span class="text-danger">*</span></label>
                        <input 
                            type="text" 
                            class="form-control" 
                            id="notion_database_id" 
                            name="notion_database_id" 
                            value="{% if selected_credential %}{{ selected_credential.notion_database_id }}{% endif %}"
                            required
                            placeholder="e.g., 1234567890abcdef1234567890abcdef"
                        >
                        <small class="form-text text-muted">The ID of the Notion database to sync notes to</small>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> 
                            {% if selected_credential %}Update{% else %}Save{% endif %} Credentials
                        </button>
                        {% if selected_credential %}
                        <a href="{% url 'credential_config' %}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Cancel
                        </a>
                        {% endif %}
                    </div>
                </form>
                
                {% if selected_credential %}
                <hr class="my-4">
                <form method="post" onsubmit="return confirm('Are you sure you want to delete these credentials? This action cannot be undone.');">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="delete">
                    <input type="hidden" name="user_id" value="{{ selected_user_id }}">
                    <div class="d-grid">
                        <button type="submit" class="btn btn-danger">
                            <i class="bi bi-trash"></i> Delete Credentials
                        </button>
                    </div>
                </form>
                {% endif %}
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">Security Information</h6>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    <li>All credentials are encrypted using AES-256 encryption before storage</li>
                    <li>Encryption keys are managed securely via AWS Secrets Manager</li>
                    <li>Credentials are never logged or displayed in plain text</li>
                    <li>All API communications use HTTPS</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Existing Credentials List -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Existing Credentials</h5>
            </div>
            <div class="card-body">
                {% if credentials %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>User ID</th>
                                <th>Notion Database</th>
                                <th>Last Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for credential in credentials %}
                            <tr {% if credential.user_id == selected_user_id %}class="table-active"{% endif %}>
                                <td>
                                    <strong>{{ credential.user_id }}</strong>
                                </td>
                                <td>
                                    <code class="small">{{ credential.notion_database_id|truncatechars:20 }}</code>
                                </td>
                                <td>
                                    <small>{{ credential.updated_at|date:"Y-m-d H:i" }}</small>
                                </td>
                                <td>
                                    <a href="?user_id={{ credential.user_id }}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-pencil"></i> Edit
                                    </a>
                                    <form method="post" action="{% url 'clear_sync_state' credential.user_id %}" style="display: inline;" onsubmit="return confirm('Clear sync state for {{ credential.user_id }}? This will cause the next sync to create new Notion pages instead of updating existing ones. Use this if you deleted Notion pages manually.');">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-outline-warning" title="Clear sync state (for testing)">
                                            <i class="bi bi-arrow-clockwise"></i> Clear State
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info mb-0">
                    <i class="bi bi-info-circle"></i> No credentials configured yet. Add your first credential using the form on the left.
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">How to Get Credentials</h6>
            </div>
            <div class="card-body">
                <h6>Google Keep Credentials:</h6>
                <ol class="small">
                    <li>Obtain an OAuth token from Google</li>
                    <li>Go to: <a href="https://accounts.google.com/EmbeddedSetup" target="_blank">Google Embedded Setup</a></li>
                    <li>Log in and open Developer Tools (F12)</li>
                    <li>Go to Application → Cookies → accounts.google.com</li>
                    <li>Copy the 'oauth_token' value</li>
                    <li>Convert OAuth token to master token using the provided script</li>
                    <li>Enter your Gmail address as username and the master token here</li>
                </ol>
                <div class="alert alert-warning small mb-3">
                    <strong>Note:</strong> Google Keep doesn't have an official API for personal accounts. We use master tokens obtained from OAuth tokens. See the project documentation for the conversion script.
                </div>
                
                <h6 class="mt-3">Notion API Token:</h6>
                <ol class="small">
                    <li>Go to <a href="https://www.notion.so/my-integrations" target="_blank">Notion Integrations</a></li>
                    <li>Click "New integration"</li>
                    <li>Give it a name and select capabilities</li>
                    <li>Copy the "Internal Integration Token"</li>
                    <li>Share your database with the integration</li>
                </ol>
                
                <h6 class="mt-3">Notion Database ID:</h6>
                <p class="small mb-0">
                    Open your Notion database in a browser. The database ID is the 32-character string in the URL:
                    <br>
                    <code class="small">https://notion.so/[workspace]/[DATABASE_ID]?v=...</code>
                </p>
            </div>
        </div>
    </div>
</div>

<script>
// Clear password fields when editing to avoid showing masked values
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('credentialForm');
    const googleTokenField = document.getElementById('google_oauth_token');
    const notionTokenField = document.getElementById('notion_api_token');
    
    // If editing, clear the masked values on focus
    {% if selected_credential %}
    googleTokenField.addEventListener('focus', function() {
        if (this.value === '********') {
            this.value = '';
        }
    });
    
    notionTokenField.addEventListener('focus', function() {
        if (this.value === '********') {
            this.value = '';
        }
    });
    
    // Validate that tokens are not left as masked values
    form.addEventListener('submit', function(e) {
        if (googleTokenField.value === '********' || notionTokenField.value === '********') {
            e.preventDefault();
            alert('Please enter the actual token values. The masked values cannot be submitted.');
            return false;
        }
    });
    {% endif %}
});
</script>
{% endblock %}
